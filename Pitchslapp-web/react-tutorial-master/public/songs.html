<!DOCTYPE html>
<html lang="en-US">
<html>
  <head>
    <meta charset="utf-8">
    <title>Pitchslapp</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="0t2k59m96bjkpw3"></script>
    <link rel="icon" 
          type="image/png" 
          href="resources/favicon.png">
    <style>
      body {
        font-family: 'Avenir', sans-serif;
        font-size: 16px;
      }
    </style>

  </head>
  <body style="text-align: center; background-color: #F7CAC9";>
    <h1>Pitchslapp</h1>
    <div id='messagesDiv'></div>
    <input style="text-align:center" type='text' id='nameInput' placeholder='Name of Song'>
    <br>
    <input style="text-align:center" type='text' id='soloInput' placeholder='Name of Soloist'>
    <br>
    <input style="text-align:center" type='text' id='keyInput' placeholder='Key of Song'>
    <br>
    <div id='container'> </div>
    <br>
    <button type="button" id="submitButton">Submit Song</button>
    <ul id="records"></ul>
    <div id="content"></div>
    <h2><a href="index.html">Back to Groups</a>
    <script type="text/babel">
      function myFunction() {        
        alert("removed!");
      };
      function getQueryVariable(variable)
      {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
        }
        return(false);
      }
      var group = getQueryVariable("group");
      var song_of_page = getQueryVariable("song");
      console.log("your group is " + group);
      console.log("your song is " + song_of_page);

      if (song_of_page == false) {
        var ref = new Firebase("https://popping-inferno-1963.firebaseio.com/groups/"+group+"/songs");
      } else {
        var ref = new Firebase("https://popping-inferno-1963.firebaseio.com/groups/"+group+"/songs/"+song_of_page);

            $('#keyInput').remove();
            $('#nameInput').remove();
            $('#soloInput').remove();
            $('#submitButton').remove();
            $('#container').remove();
        ref.once("value", function(data) {
          $('<div/>').html("<h2>Song: " + data.val().name +"</h2>").prepend($('<em/>')).appendTo($('#messagesDiv'));
            $('<div/>').text("Key: " + data.val().key).prepend($('<em/>').text(' ')).appendTo($('#messagesDiv'));
            $('<div/>').text("Soloist: " + data.val().solo).prepend($('<em/>').text(' ')).appendTo($('#messagesDiv'));($('<em/>').text(' ')).appendTo($('#messagesDiv'));
            $('<div/>').text("Tags: " + data.val().tags).prepend($('<em/>').text(' ')).appendTo($('#messagesDiv'));
            $('<div/>').html("<a href='" + data.val().pdfUrl + "'> To Download Sheet Music - Click Here </a>").prepend($('<em/>').text(' ')).appendTo($('#messagesDiv'));
            $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
          
        });

  
      }
      var pdfUrl = "";
      function addSong() {
        var name = $('#nameInput').val();
        var solo = $('#soloInput').val();
        var keyVal = $('#keyInput').val();
        var id = ref.push({
          solo: solo,
          name: name,
          key: keyVal,
          pdfUrl: pdfUrl
        });
        console.log(id);
        $('#nameInput').val('');
        $('#soloInput').val('');
        $('#keyInput').val('Song Added!');
      }
      $('#submitButton').click(function (e) {
        addSong();
      });
      $('#keyInput').keypress(function (e) {
        if (e.keyCode == 13) {
          addSong();
        }
      });
      ref.on('child_added', function(snapshot) {
        var message = snapshot.val();
        if (song_of_page == false) {
        displaySong(message.name, message.solo, message.key, snapshot.key(), message.pdfUrl);
        } 
      });
      function deleteSong(deletedSong) {
        var newRef = ref.child(deletedSong);
        newRef.remove();
      }
      function displaySong(name, soloist, key, id, dropbox_link) {
        $('<div/>').text(soloist).prepend($('<em/>').html('<button id="'+id+'">Delete</button>' + '<a href=songs.html?group=' + group + '&song='+id+'   style="color:black" target="_blank" > '+name+' ('+key+'): ')).appendTo($('#messagesDiv'));
        document.getElementById(id).onclick = function() {deleteSong(id)};
        $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
      };
      ref.on('child_removed', function(snapshot) {  
        var deletedSong = snapshot.val().name;
        console.log("The song titled '" + deletedSong + "' has been deleted");
        $('#messagesDiv').find( ":contains('"+ deletedSong + "')" ).remove();
      });
      var options = {
        // Required. Called when a user selects an item in the Chooser.
        success: function(files) {
            pdfUrl = files[0].link;
        },
        // Optional. Called when the user closes the dialog without selecting a file
        // and does not include any parameters.
        cancel: function() {

        },
        // Optional. "preview" (default) is a preview link to the document for sharing,
        // "direct" is an expiring link to download the contents of the file. For more
        // information about link types, see Link types below.
        linkType: "preview", // or "direct"

        // Optional. A value of false (default) limits selection to a single file, while
        // true enables multiple file selection.
        multiselect: false, // or true

        // Optional. This is a list of file extensions. If specified, the user will
        // only be able to select files with these extensions. You may also specify
        // file types, such as "video" or "images" in the list. For more information,
        // see File types below. By default, all extensions are allowed.
        extensions: ['.pdf', '.doc', '.docx', '.jpg'],
      };
      
      var button = Dropbox.createChooseButton(options);
      document.getElementById("container").appendChild(button);
    </script>
  </body>
</html>
