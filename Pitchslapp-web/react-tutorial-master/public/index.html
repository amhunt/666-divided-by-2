<!DOCTYPE html>
<html lang="en-US">
<html>
  <head>
    <meta charset="utf-8">
    <title>Pitchslapp</title>
    <link rel="stylesheet" href="css/base.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
    <link rel="icon" 
          type="image/png" 
          href="resources/favicon.png">
    <style>
      body {
        font-family: 'Avenir', sans-serif;
        font-size: 16px;
      }
    </style>
  </head>
  <body style="text-align: left; background-color: #ffffff; color: #77218d">
    <h1>Pitchslapp</h1>
    <div class="login">
        <h3>Login:</h3>
          <ul style="list-style-type:none">
            <li> <label for="email">Email </label>
            <input type="text" size="30" name="email" id="email"/> </li>
            <li> <label for="pw">Password </label>
            <input type="password" size="30" name="pw" id="pw"/> </li>
            <li> <label></label>
            <div id="login_err"></div>
            <input type="submit" id="login" name="login" value="Login" class="loginbutton"></li>
          </ul>
        <h3>Create New User:</h3>
          <ul style="list-style-type:none">
            <li> <label for="name_new">Name </label>
            <input type="text" size="30" name="name_new" id="name_new"/> </li>
            <li> <label for="email_new">Email </label>
            <input type="text" size="30" name="email_new" id="email_new"/> </li>
            <li> <label for="pw_new">Password </label>
            <input type="password" size="30" name="pw_new" id="pw_new"/> </li>
            <li> <label></label>
            <div id="group_location"> </div>
            <input type="submit" id="new_account" name="new_account" value="Create New Account" class="loginbutton"></li>
          </ul>
        </fieldset>
    <br>
    <!-- <h2>Available Groups</h2>        -->
    <!-- <h3>Create a new group:</h3> -->
    <!-- <input style="text-align:center" type='text' id='nameInput' placeholder='Group Name'> -->
    <!-- <br> -->
    <!-- <input style="text-align:center" type='text' id='schoolInput' placeholder='School Name'> -->
    <br>
    <br>
    <div style="text-align:center">Â© 2016 Social Coders</div>
    <ul id="records"></ul>
    <div id="content"></div> 
    <script type="text/babel">
      var ref = new Firebase("https://popping-inferno-1963.firebaseio.com/groups");
      $(document).ready(function(){
        // $("#add_err").css('display', 'none', 'important');
        $('#login').click(function() {
          var email = $("#email").val();
          var password = $("#pw").val();
          var ref = new Firebase("https://popping-inferno-1963.firebaseio.com");
          ref.authWithPassword({
            "email": email,
            "password": password
          }, function(error, authData) {
            if (error) {
              $('#login_err').append('<div style="color:red">Invalid Login Info</div>');
              console.log("Login Failed!", error);
              alert("Login Failed");
            } else {
              console.log("Authenticated successfully with user:", authData);
              // var user_uid = authData;
              var user_uid = authData.uid;
              var user_ref = ref.child('users').child(user_uid);
              user_ref.once("value", function(snapshot) {
                var group_id = snapshot.val().groupid;
                window.location.href ='songs.html?group=' + group_id;
              });
            }
          });
        });
        $('#new_account').click(function() {
          var name = $("#name_new").val();
          var email = $("#email_new").val();
          var password = $("#pw_new").val();
          var ref = new Firebase("https://popping-inferno-1963.firebaseio.com");
          ref.createUser({
            "email": email,
            "password": password
          }, function(error, authData) {
            if (error) { 
              switch (error.code) {
                case "EMAIL_TAKEN":
                  $('#login_err').append('<div style="color:red">User already exists, email in use</div>');
                  console.log("The new user account cannot be created because the email is already in use.");
                  break;
                case "INVALID_EMAIL":
                  $('#login_err').append('<div style="color:red">Invalid Email Address</div>');
                  console.log("The specified email is not a valid email.");
                  break;
                default:
                  $('#login_err').append('<div style="color:red">Error Creating User</div>');
                  console.log("Error creating user:", error);
              }
            } else {
              console.log("Succesfully created user:", authData);
              var user_uid = authData.uid;
              // var obj = {};
              // obj[user_uid] = {email: email, groupid: "", name: name};
              // var user_ref = ref.child('users').update(obj);

              ref.once("value", function(snapshot) {
                var groups = snapshot.child("groups").val();
                console.log(groups);
                $("#group_location").append("<div>Choose A Group To Join</div>");
                for (var key in groups) {
                  var group = groups[key];
                  $("#group_location").append('<div><input type="button" id="' + key + '" name="new_account" value="' + 
                        group.name + ': ' + group.school + '" class="loginbutton"> </div>');
                  var new_button = Document.getElementById(key);
                  $("#"+key).click(function() {
                    alert("clicked " + key);
                    var obj = {};
                    obj[user_uid] = {email: email, groupid: key, name: name};
                    var user_ref = ref.child('users').update(obj);
                    // window.location.href ='songs.html?group=' + the_group;
                  });
                  // $("#group_location").append("<div><a href=songs.html?group=" + key + ">" + group.name + ": " + group.school + "</a> </div>");
                }
              });
            }
          });

        });
      });
      $('#schoolInput').keypress(function (e) {
        if (e.keyCode == 13) {
          var name = $('#nameInput').val();
          var school = $('#schoolInput').val();
          ref.push({
            name: name,
            school: school
          });
          $('#nameInput').val('');
          $('#schoolInput').val(name+ ' has been added');
        }
      });

      ref.on('child_added', function(snapshot) {
        var message = snapshot.val();
        // displayChatMessage(message.name, message.school, snapshot.key());
      });

      ref.on('child_removed', function(snapshot) {
        deletedGroup = snapshot.val().name;
        $('#messagesDiv').find( ":contains('"+ deletedGroup+ "')" ).remove();

       // $('#messagesDiv').find('[data-id="'+snapshot.key()+'"]').remove();
     });

      function displayChatMessage(name, school, id) {
        // $('<div/>').text(school).prepend($('<em/>').html('<a href=songs.html?group=' + id + ' target="_blank" style="color:black"> '+name+": ")).appendTo($('#messagesDiv'));
        // $('<div/>').text(school).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
        $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
      };
    </script>

  </body>
</html>
