<!DOCTYPE html>
<html lang="en-US">
<html>
  <head>
    <meta charset="utf-8">
    <title>Pitchslapp</title>
    <link rel="stylesheet" href="css/base.css"/>
    <!-- <link rel="stylesheet" href="css/normalize.css"/> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
    <link rel="icon" 
          type="image/png" 
          href="resources/favicon.png">
    <style>
      body {
        font-family: 'Avenir', sans-serif;
        font-size: 16px;
      }
    </style>
  </head>
  <body style="text-align: center; background-color: #ffffff; color: #77218d">
    <h1>Pitchslapp</h1>
    <div class="login">
        <h3>Login:</h3>
        <div class="err" id="add_err"></div>
        <fieldset>
          <form action="./" method="post">
            <ul>
              <li> <label for="name">Username</label>
              <input type="text" size="30" name="name" id="name"/> </li>
              <li> <label for="name">Password </label>
              <input type="password" size="30" name="word" id="word"/> </li>
              <li> <label></label>
              <input type="submit" id="login" name="login" value="Login" class="loginbutton"></li>
            </ul>
          </form>
        </fieldset>
        </div>
    <br>
    <h2>Available Groups</h2>       
    <div id='messagesDiv'></div>
    <br>
    <h3>Create a new group:</h3>
    <input style="text-align:center" type='text' id='nameInput' placeholder='Group Name'>
    <br>
    <input style="text-align:center" type='text' id='schoolInput' placeholder='School Name'>

    <ul id="records"></ul>
    <div id="content"></div> 
    <script type="text/babel">
      var ref = new Firebase("https://popping-inferno-1963.firebaseio.com/groups");
      $(document).ready(function(){
        $("#add_err").css('display', 'none', 'important');
          $('#login').click(function()) {
            username=$("#name").val();
            password=$("#word").val();
            $.ajax({
              type: "POST",
              url: "login.php",
              data: "name="+username+"&pwd="+password,
              success: function(html) {
                if (html==true) {
                  window.location="dashboard.php"
                }
                else {
                  $('#add_err').css('display', 'inline', 'important');
                  $("#add_err").html("<img src='images/alert.png' />Wrong username or password");
                }
              },
              beforeSend:function()
              {
                $('#add_err').css('display', 'inline', 'important');
                $("#add_err").html("<img src='images/ajax-loader.gif' /> Loading...")
              }
            });
            return false;
          });
      $('#schoolInput').keypress(function (e) {
        if (e.keyCode == 13) {
          var name = $('#nameInput').val();
          var school = $('#schoolInput').val();
          ref.push({
            name: name,
            school: school
          });
          $('#nameInput').val('');
          $('#schoolInput').val(name+ ' has been added');
        }
      });

      ref.on('child_added', function(snapshot) {
        var message = snapshot.val();
        displayChatMessage(message.name, message.school, snapshot.key());
      });

      ref.on('child_removed', function(snapshot) {
        deletedGroup = snapshot.val().name;
        $('#messagesDiv').find( ":contains('"+ deletedGroup+ "')" ).remove();

       // $('#messagesDiv').find('[data-id="'+snapshot.key()+'"]').remove();
     });

      function displayChatMessage(name, school, id) {
        $('<div/>').text(school).prepend($('<em/>').html('<a href=songs.html?group=' + id + ' target="_blank" style="color:black"> '+name+": ")).appendTo($('#messagesDiv'));
        // $('<div/>').text(school).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
        $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
      };
    </script>
  </body>
</html>
